# Continue Bookinfo

In this example we like to see how easy it is to attach a new service to the service mesh.
For this reason we will create a v4 of reviews (with green stars :-) )

## Preparation

We need to change two files:

_swagger.yaml_

Here we add green in the enum to keep everything compliant.

_build-service.sh_

Since the code of the bookinfo application is highly explanatory, the code gets generated by this file.
So instead of changing a Java-File, we can simply adjust the creation of a new review with other parameters.

```docker build --pull -t "${PREFIX}/examples-bookinfo-reviews-v4:${VERSION}" -t "${PREFIX}/examples-bookinfo-reviews-v4:latest" --build-arg service_version=v3 \
--build-arg enable_ratings=true --build-arg star_color=green .
```

It looks quite similar to v3 but the color of the stars has changed.

## Uploading the changes

The changes now need to be deployed to a docker repository. The easiest one to use is docker io.
The only commands needed are ```docker login``` to get authorized.

After this we can use:

```
./build_push_update_images.sh 1.17 --prefix=davidpinezich
```

To push everything to an own repository (prefix adjusted to the repository).

## Config changes

Now we need to change the configuration in:

_bookinfo.yaml_


```apiVersion: apps/v1
kind: Deployment
metadata:
name: reviews-v4
labels:
app: reviews
version: v4
spec:
replicas: 1
selector:
matchLabels:
app: reviews
version: v4
template:
metadata:
labels:
app: reviews
version: v4
spec:
serviceAccountName: bookinfo-reviews
containers:
- name: reviews
image: docker.io/davidpinezich/examples-bookinfo-reviews-v4:1.17
imagePullPolicy: IfNotPresent
env:
- name: LOG_DIR
value: "/tmp/logs"
ports:
- containerPort: 9080
volumeMounts:
- name: tmp
mountPath: /tmp
- name: wlp-output
mountPath: /opt/ibm/wlp/output
securityContext:
runAsUser: 1000
volumes:
- name: wlp-output
emptyDir: {}
- name: tmp
emptyDir: {}
```

The speciality of this file is:
```
image: docker.io/davidpinezich/examples-bookinfo-reviews-v4:1.17
```

As you can see - instead of the example repo of istio, here a personal one is used.
This is important since the official repo has no v4 with beautiful green stars.

## Re-Install

Since v4 is now known on our docker repository and we have changed the certain part in the configuration, we can update our local mesh configuration.
For this we can simply use:

```
kubectl.exe apply -f platform/kube/bookinfo.yaml 
```

and get:
```
service/details unchanged
serviceaccount/bookinfo-details unchanged
deployment.apps/details-v1 unchanged
service/ratings unchanged
serviceaccount/bookinfo-ratings unchanged
deployment.apps/ratings-v1 unchanged
service/reviews unchanged
serviceaccount/bookinfo-reviews unchanged
deployment.apps/reviews-v1 unchanged
deployment.apps/reviews-v2 unchanged
deployment.apps/reviews-v3 unchanged
deployment.apps/reviews-v4 created
service/productpage unchanged
serviceaccount/bookinfo-productpage unchanged
deployment.apps/productpage-v1 unchanged
```

where ```deployment.apps/reviews-v4 created``` was our target.